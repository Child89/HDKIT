<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HDKit Pair-Time Data Table</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: system-ui, sans-serif; margin: 40px; background: #fafafa; }
  form { margin-bottom: 30px; }
  label { display: block; margin-top: 10px; }
  input { padding: 6px; width: 220px; }
  button { margin-top: 20px; padding: 10px 20px; font-size: 15px; cursor: pointer; }
  table { border-collapse: collapse; width: 100%; font-size: 14px; background: white; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { background: #f2f2f2; position: sticky; top: 0; }
  th button.sort-btn { background: none; border: none; cursor: pointer; margin-left: 5px; font-size: 12px; }
  tr.highlight { background: #b9e0ff !important; transition: background 1s ease; }
  tr:hover { background: #f5faff; }
  #output { white-space: pre; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 20px; }
</style>
</head>
<body>

<h1>HDKit Pair-Time Data Table</h1>

<form id="calcForm">
  <label>DateTime 1: <input type="datetime-local" name="dt1" required></label>
  <label>Latitude 1: <input type="number" name="lat1" step="any" required></label>
  <label>Longitude 1: <input type="number" name="lon1" step="any" required></label>

  <label>DateTime 2: <input type="datetime-local" name="dt2" required></label>
  <label>Latitude 2: <input type="number" name="lat2" step="any" required></label>
  <label>Longitude 2: <input type="number" name="lon2" step="any" required></label>

  <button type="submit">Run HDKit Pair</button>
</form>

<div id="loading" style="display:none;">⏳ Running hdkit pair...</div>
<pre id="output"></pre>

<table id="dataTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Date</th>
      <th>Fire <button class="sort-btn" data-field="fire">⇅</button></th>
      <th>Peace <button class="sort-btn" data-field="peace">⇅</button></th>
      <th>Growth <button class="sort-btn" data-field="growth">⇅</button></th>
      <th>Stability <button class="sort-btn" data-field="stability">⇅</button></th>
      <th>Diversity <button class="sort-btn" data-field="diversity">⇅</button></th>
      <th>Meditate <button class="sort-btn" data-field="meditate">⇅</button></th>
      <th>avgFirePeaceScore <button class="sort-btn" data-field="avgFirePeaceScore">⇅</button></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let baseData = [];
let liveItem = null; // stores current HDKit "Live" result
let currentSort = { field: "avgFirePeaceScore", desc: true };
const tableBody = document.querySelector("#dataTable tbody");
const output = document.getElementById("output");
const loading = document.getElementById("loading");

// Load dataset
async function loadBaseData() {
  const res = await fetch("/2025-11-07T07-24-28-986Z-pair-time.json");
  const json = await res.json();

  baseData = json.scores.map(entry => {
    const s = entry.score;
    return {
      date: entry.date,
      fire: s.fire,
      peace: s.peace,
      growth: s.growth,
      stability: s.stability,
      diversity: s.diversity,
      meditate: s.meditate,
      avgFirePeaceScore: (s.fire + s.peace) * 0.5
    };
  });

  sortAndRender();
}

// Sort + render (always includes live item if present)
function sortAndRender() {
  const { field, desc } = currentSort;
  let combined = [...baseData];
  if (liveItem) {
    // Remove old "Live" if exists in combined before reinserting
    combined = combined.filter(item => item.date !== "Live");
    combined.push(liveItem);
  }

  const sorted = combined.sort((a, b) => {
    let av = a[field], bv = b[field];
    if (typeof av === "boolean") { av = av ? 1 : 0; bv = bv ? 1 : 0; }
    return desc ? bv - av : av - bv;
  });

  const highlightIndex = liveItem ? sorted.findIndex(d => d.date === "Live") : null;
  renderTable(sorted, highlightIndex);

  // Scroll to highlight if exists
  if (highlightIndex !== null) {
    setTimeout(() => {
      const row = tableBody.querySelector(".highlight");
      if (row) row.scrollIntoView({ behavior: "smooth", block: "center" });
    }, 100);
  }
}

// Render table
function renderTable(data, highlightIndex = null) {
  tableBody.innerHTML = "";
  data.forEach((d, i) => {
    const row = document.createElement("tr");
    if (i === highlightIndex) row.classList.add("highlight");
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${d.date}</td>
      <td>${d.fire.toFixed(2)}</td>
      <td>${d.peace.toFixed(2)}</td>
      <td>${d.growth.toFixed(2)}</td>
      <td>${d.stability.toFixed(2)}</td>
      <td>${d.diversity.toFixed(2)}</td>
      <td>${d.meditate ? "✅" : "❌"}</td>
      <td>${d.avgFirePeaceScore.toFixed(2)}</td>
    `;
    tableBody.appendChild(row);
  });
}

// Sorting buttons with Live item reposition logic
document.querySelectorAll(".sort-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const field = btn.dataset.field;
    const sameField = currentSort.field === field;
    currentSort = { field, desc: sameField ? !currentSort.desc : true };
    sortAndRender(); // automatically repositions the live row
  });
});

// Handle HDKit calculation
document.getElementById("calcForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const obj = Object.fromEntries(formData.entries());
  loading.style.display = "block";
  output.textContent = "";

  try {
    const res = await fetch("/run", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(obj)
    });
    const hdData = await res.json();
    loading.style.display = "none";
    output.textContent = JSON.stringify(hdData, null, 2);
    if (hdData.error) return;

    // store new live item
    liveItem = {
      date: "Live",
      fire: hdData.fireScore,
      peace: hdData.peaceScore,
      growth: hdData.growthScore,
      stability: hdData.stability,
      diversity: hdData.diversityS,
      meditate: hdData.areMeditative,
      avgFirePeaceScore: (hdData.fireScore + hdData.peaceScore) * 0.5
    };

    sortAndRender(); // inserts in correct place based on current sorting
  } catch (err) {
    loading.style.display = "none";
    output.textContent = "❌ " + err.message;
  }
});

// Initialize
loadBaseData();
</script>
</body>
</html>
